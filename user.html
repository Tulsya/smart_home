<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>–ú–æ–π Smart Home</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }

        h1 {
            text-align: center;
        }

        .step {
            display: none;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .step.active {
            display: block;
        }

        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        select,
        input[type="text"],
        textarea {
            padding: 10px;
            margin: 10px 0;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #progress {
            text-align: center;
            margin-top: 10px;
            color: #555;
        }

        .floorplan-preview {
            max-width: 100%;
            max-height: 300px;
            border: 2px dashed #007bff;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #777;
            padding: 10px;
        }

        .floorplan-preview img {
            max-width: 100%;
            max-height: 280px;
            border-radius: 6px;
        }

        #roomSelector {
            margin-top: 15px;
        }

        .room-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .room-row:hover {
            background-color: #f5f5f5;
        }

        .room-row button {
            flex: 0 0 140px;
        }

        .room-row .count {
            margin-left: 10px;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }

        .room-hint {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .device-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }

        .device-name {
            font-weight: bold;
            margin-bottom: 10px;
        }

        #saveBtn {
            background: #28a745;
            width: 100%;
            font-size: 16px;
            padding: 12px;
            margin-top: 20px;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>üè† –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Smart Home</h1>
    <div id="progress">–®–∞–≥ <span id="stepNum">1</span>/3</div>

    <!-- –®–∞–≥ 1: –¢–∏–ø –∫–≤–∞—Ä—Ç–ø–ª–∞—Ç—ã -->
    <div class="step active" id="step1">
        <h2>1. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–∞—Å—á–µ—Ç–∞</h2>
        <select id="paymentType">
            <option value="standard">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è (–ø–æ –ø–ª–æ—â–∞–¥–∏)</option>
            <option value="consumption">–ü–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—é</option>
            <option value="fixed">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</option>
        </select>
        <div class="navigation-buttons">
            <div></div>
            <button onclick="nextStep()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚Üí</button>
        </div>
    </div>

    <!-- –®–∞–≥ 2: –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ + —Ñ–æ—Ç–æ + –≤—ã–±–æ—Ä –∫–æ–º–Ω–∞—Ç -->
    <div class="step" id="step2">
        <h2>2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—ã</h2>
        <input type="file" id="floorplanImage" accept="image/*" onchange="previewImage()">
        <div id="floorplanPreview" class="floorplan-preview">
            üì∑ –ù–∞–∂–º–∏—Ç–µ ¬´–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª¬ª, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏
        </div>

        <div id="roomSelector">
            <h3>–ö–æ–º–Ω–∞—Ç—ã –Ω–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–µ</h3>
            <div class="room-row" data-base="–ì–æ—Å—Ç–∏–Ω–∞—è" oncontextmenu="decRoom(this); return false;">
                <button type="button" onclick="incRoom(this)">–ì–æ—Å—Ç–∏–Ω–∞—è</button>
                <span class="count">0</span>
            </div>
            <div class="room-row" data-base="–°–ø–∞–ª—å–Ω—è" oncontextmenu="decRoom(this); return false;">
                <button type="button" onclick="incRoom(this)">–°–ø–∞–ª—å–Ω—è</button>
                <span class="count">0</span>
            </div>
            <div class="room-row" data-base="–ö—É—Ö–Ω—è" oncontextmenu="decRoom(this); return false;">
                <button type="button" onclick="incRoom(this)">–ö—É—Ö–Ω—è</button>
                <span class="count">0</span>
            </div>
            <div class="room-row" data-base="–ö–æ—Ä–∏–¥–æ—Ä" oncontextmenu="decRoom(this); return false;">
                <button type="button" onclick="incRoom(this)">–ö–æ—Ä–∏–¥–æ—Ä</button>
                <span class="count">0</span>
            </div>
            <div class="room-row" data-base="–ë–∞–ª–∫–æ–Ω" oncontextmenu="decRoom(this); return false;">
                <button type="button" onclick="incRoom(this)">–ë–∞–ª–∫–æ–Ω</button>
                <span class="count">0</span>
            </div>
            <div class="room-row" data-base="–°–∞–Ω—É–∑–µ–ª" oncontextmenu="decRoom(this); return false;">
                <button type="button" onclick="incRoom(this)">–°–∞–Ω—É–∑–µ–ª</button>
                <span class="count">0</span>
            </div>
            <div class="room-hint">üí° –õ–µ–≤—ã–π –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ - –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É. –ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ - —É–±—Ä–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
            </div>
        </div>

        <h3>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏ (JSON)</h3>
        <textarea id="floorplanJSON" readonly style="margin-top:10px; height: 100px;"
            placeholder='–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏ –≤ JSON –±—É–¥–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏'></textarea>

        <div class="navigation-buttons">
            <button onclick="prevStep()">‚Üê –ù–∞–∑–∞–¥</button>
            <button onclick="nextStep()">–î–∞–ª–µ–µ ‚Üí</button>
        </div>
    </div>

    <!-- –®–∞–≥ 3: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å –≤–≤–æ–¥–æ–º –Ω–∞–∑–≤–∞–Ω–∏—è -->
    <div class="step" id="step3">
        <h2>3. –î–æ–±–∞–≤—å—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h2>
        <div style="margin-bottom: 15px;">
            <input type="text" id="deviceName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –õ–∞–º–ø–∞ –≤ –≥–æ—Å—Ç–∏–Ω–æ–π)">
            <button onclick="addDevice()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
        </div>
        <div id="devicesList" class="devices-grid"></div>

        <button id="save-setup-btn" onclick="saveSetup()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É</button>

        <div class="navigation-buttons">
            <button onclick="prevStep()">‚Üê –ù–∞–∑–∞–¥</button>
            <div></div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let devices = [];
        let floorplanImageData = '';
        const API_BASE = 'http://localhost:8082/api';

        function nextStep() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –Ω–∞ —à–∞–≥ 2
            if (currentStep === 1) {
                const paymentType = document.getElementById('paymentType').value;
                if (!paymentType) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–∞—Å—á–µ—Ç–∞!');
                    return;
                }
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –Ω–∞ —à–∞–≥ 3
            if (currentStep === 2) {
                updateFloorplanJSON();
                const floorplanJSON = document.getElementById('floorplanJSON').value;
                const floorplanObj = JSON.parse(floorplanJSON || '{"rooms":[]}');

                if (floorplanObj.rooms.length === 0) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–æ–º–Ω–∞—Ç—É!');
                    return;
                }
            }

            document.getElementById(`step${currentStep}`).classList.remove('active');
            currentStep++;
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.getElementById('stepNum').textContent = currentStep;
        }

        function prevStep() {
            document.getElementById(`step${currentStep}`).classList.remove('active');
            currentStep--;
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.getElementById('stepNum').textContent = currentStep;
        }

        function previewImage() {
            const file = document.getElementById('floorplanImage').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                floorplanImageData = e.target.result; // base64
                document.getElementById('floorplanPreview').innerHTML =
                    `<img src="${floorplanImageData}" alt="–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞">`;
                updateFloorplanJSON();
            };
            reader.readAsDataURL(file);
        }

        // –£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç—ã
        function incRoom(btn) {
            const row = btn.parentElement;
            const span = row.querySelector('.count');
            let n = parseInt(span.textContent || '0', 10) + 1;
            span.textContent = n;
            updateFloorplanJSON();
        }

        // –£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç—ã (–ø–æ –ø—Ä–∞–≤–æ–º—É –∫–ª–∏–∫—É –Ω–∞ —Å—Ç—Ä–æ–∫–µ)
        function decRoom(rowElem) {
            const span = rowElem.querySelector('.count');
            let n = parseInt(span.textContent || '0', 10) - 1;
            if (n < 0) n = 0;
            span.textContent = n;
            updateFloorplanJSON();
        }

        // –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å JSON –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏
        function updateFloorplanJSON() {
            const rooms = [];
            document.querySelectorAll('#roomSelector .room-row').forEach(row => {
                const base = row.getAttribute('data-base');
                const n = parseInt(row.querySelector('.count').textContent || '0', 10);
                for (let i = 1; i <= n; i++) {
                    rooms.push(n > 1 ? `${base} ${i}` : base);
                }
            });
            const obj = {
                rooms: rooms,
                image: floorplanImageData || null
            };
            document.getElementById('floorplanJSON').value = JSON.stringify(obj, null, 2);
        }

        function addDevice() {
            const name = document.getElementById('deviceName').value.trim();
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞!');
                return;
            }
            devices.push({
                name: name,
                id: Date.now() + Math.random()
            });
            document.getElementById('deviceName').value = '';
            renderDevices();
        }

        function renderDevices() {
            const container = document.getElementById('devicesList');
            container.innerHTML = '';
            devices.forEach((device, index) => {
                const card = document.createElement('div');
                card.className = 'device-card';
                card.innerHTML = `
                <div class="device-name">${device.name}</div>
                <button onclick="removeDevice(${index})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            `;
                container.appendChild(card);
            });
        }

        function removeDevice(index) {
            devices.splice(index, 1);
            renderDevices();
        }

        async function saveSetup() {
            try {
                // 1. –î–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                const deviceName = document.getElementById('deviceName').value.trim() || '–£–º–Ω–∞—è –ª–∞–º–ø–æ—á–∫–∞ –Ø–Ω–¥–µ–∫—Å, E27, 806 –ª–º';
                const roomId = 1;

                // 2. –°–æ–∑–¥–∞—ë–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
                const deviceResp = await fetch(`${API_BASE}/devices`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=utf-8' },  // ‚Üê –¥–æ–±–∞–≤—å charset=utf-8
                    body: JSON.stringify({
                        name: deviceName,
                        room_id: roomId
                    })
                });


                if (!deviceResp.ok) {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: ' + deviceResp.status);
                    return;
                }

                const device = await deviceResp.json();

                // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Å ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                const floorplanData = document.getElementById('floorplanJSON').value;

                const setupResp = await fetch(`${API_BASE}/user/setup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=utf-8' },  // ‚Üê –¥–æ–±–∞–≤—å charset=utf-8
                    body: JSON.stringify({
                        user_id: 1,
                        device_id: device.id,
                        payment_type: document.getElementById('paymentType').value,
                        floorplan: floorplanData
                    })
                });

                if (!setupResp.ok) {
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: ' + setupResp.status);
                    return;
                }

                alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞! –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ID: ' + device.id);

            } catch (e) {
                console.error(e);
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

    </script>

</body>

</html>